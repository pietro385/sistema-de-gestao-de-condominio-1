<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Registrar Pagamento</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: #f5f6fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      color: #2d3436;
    }
    .container {
      max-width: 600px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      padding: 30px;
      position: relative;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid #0984e3;
    }
    h1 {
      color: #2d3436;
      margin: 0;
      font-size: 28px;
    }
    .subtitle {
      color: #636e72;
      margin-top: 5px;
    }
    #form-pagamento {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 5px;
      font-weight: 600;
      color: #2d3436;
    }
    form input, form select {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #dfe6e9;
      font-size: 1em;
      box-sizing: border-box;
    }
    .info-group {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #dfe6e9;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .info-label {
      font-weight: 600;
      color: #2d3436;
    }
    .info-value {
      color: #2d3436;
    }
    .valor-vencimento {
      background: #e8f4fc;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #0984e3;
      margin: 15px 0;
    }
    .valor-total {
      font-size: 1.2em;
      font-weight: bold;
      color: #0984e3;
    }
    .buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    form button {
      background: #0984e3;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 600;
      flex: 1;
    }
    form button:hover {
      background: #0770c5;
    }
    button[type="button"] {
      background: #636e72;
    }
    button[type="button"]:hover {
      background: #4d575a;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .success {
      background-color: #00b894;
    }
    .error {
      background-color: #d63031;
    }
    .hidden {
      display: none;
    }
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 15px auto;
      }
      .buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Registrar Pagamento</h1>
      <p class="subtitle">Registre os pagamentos do condomínio</p>
    </div>
    
    <form id="form-pagamento">
      <div class="form-group">
        <label for="apartamento">Apartamento</label>
        <input type="number" id="apartamento" placeholder="Digite o ID do apartamento" required>
      </div>
      
      <div class="form-group">
        <label for="referencia">Mês/Ano de Referência</label>
        <select id="referencia" required>
          <option value="">Carregando...</option>
        </select>
      </div>
      
      <div id="info-morador" class="info-group hidden">
        <h3>Informações do Morador</h3>
        <div class="info-row">
          <span class="info-label">CPF:</span>
          <span id="info-cpf" class="info-value">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Nome:</span>
          <span id="info-nome" class="info-value">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Telefone:</span>
          <span id="info-telefone" class="info-value">-</span>
        </div>
      </div>
      
      <div id="info-condominio" class="valor-vencimento hidden">
        <h3>Valor do Condomínio</h3>
        <div class="info-row">
          <span class="info-label">Valor:</span>
          <span id="info-valor" class="info-value valor-total">R$ 0,00</span>
        </div>
        <div class="info-row">
          <span class="info-label">Vencimento:</span>
          <span id="info-vencimento" class="info-value">-</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="data-pagamento">Data do Pagamento</label>
        <input type="date" id="data-pagamento" required>
      </div>
      
      <div class="buttons">
        <button type="submit">Registrar Pagamento</button>
        <button type="button" onclick="history.back()">Voltar</button>
      </div>
    </form>
  </div>
  
  <div class="notification" id="notification"></div>

  <script>
    // Elementos do DOM
    const formPagamento = document.getElementById('form-pagamento');
    const selectReferencia = document.getElementById('referencia');
    const inputApartamento = document.getElementById('apartamento');
    const inputDataPagamento = document.getElementById('data-pagamento');
    const notification = document.getElementById('notification');
    const infoMorador = document.getElementById('info-morador');
    const infoCondominio = document.getElementById('info-condominio');
    const infoCpf = document.getElementById('info-cpf');
    const infoNome = document.getElementById('info-nome');
    const infoTelefone = document.getElementById('info-telefone');
    const infoValor = document.getElementById('info-valor');
    const infoVencimento = document.getElementById('info-vencimento');
    
    // Valor fixo do condomínio (em um sistema real, isso viria do banco)
    const VALOR_CONDOMINIO = 350.00;
    const DIA_VENCIMENTO = 10; // Dia do vencimento
    
    // Função para exibir notificação
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
    
    // Função para formatar data no formato brasileiro
    function formatarData(data) {
      if (!data) return 'N/A';
      const [ano, mes, dia] = data.split('-');
      return `${dia}/${mes}/${ano}`;
    }
    
    // Função para formatar valor monetário
    function formatarMoeda(valor) {
      if (!valor) return 'R$ 0,00';
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }
    
    // Função para formatar CPF
    function formatarCPF(cpf) {
      if (!cpf) return 'N/A';
      cpf = cpf.replace(/\D/g, '');
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }
    
    // Função para formatar telefone
    function formatarTelefone(telefone) {
      if (!telefone) return 'N/A';
      telefone = telefone.replace(/\D/g, '');
      if (telefone.length === 11) {
        return telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }
      return telefone;
    }
    
    // Função para carregar as referências (Mês/Ano)
    async function carregarReferencias() {
      try {
        // Em um sistema real, isso viria do banco de dados
        // Simulando uma requisição
        const referencias = [
          { id: 1, mes: 1, ano: 2025, descricao: 'Janeiro/2025' },
          { id: 2, mes: 2, ano: 2025, descricao: 'Fevereiro/2025' },
          { id: 3, mes: 3, ano: 2025, descricao: 'Março/2025' },
          { id: 4, mes: 4, ano: 2025, descricao: 'Abril/2025' },
          { id: 5, mes: 5, ano: 2025, descricao: 'Maio/2025' },
          { id: 6, mes: 6, ano: 2025, descricao: 'Junho/2025' },
          { id: 7, mes: 7, ano: 2025, descricao: 'Julho/2025' },
          { id: 8, mes: 8, ano: 2025, descricao: 'Agosto/2025' },
          { id: 9, mes: 9, ano: 2025, descricao: 'Setembro/2025' },
          { id: 10, mes: 10, ano: 2025, descricao: 'Outubro/2025' },
          { id: 11, mes: 11, ano: 2025, descricao: 'Novembro/2025' },
          { id: 12, mes: 12, ano: 2025, descricao: 'Dezembro/2025' }
        ];
        
        selectReferencia.innerHTML = '<option value="">Selecione uma referência</option>';
        referencias.forEach(ref => {
          const option = document.createElement('option');
          option.value = ref.id;
          option.textContent = ref.descricao;
          option.dataset.mes = ref.mes;
          option.dataset.ano = ref.ano;
          selectReferencia.appendChild(option);
        });
        
      } catch (error) {
        showNotification('Erro ao carregar referências.', 'error');
        console.error('Erro:', error);
      }
    }
    
    // Função para buscar informações do apartamento
    async function buscarApartamento(idApartamento) {
      try {
        const response = await fetch(`/apartamentos/${idApartamento}`);
        if (!response.ok) {
          throw new Error('Apartamento não encontrado');
        }
        return await response.json();
      } catch (error) {
        showNotification('Apartamento não cadastrado.', 'error');
        console.error('Erro:', error);
        return null;
      }
    }
    
    // Função para buscar morador do apartamento
    async function buscarMorador(idApartamento) {
      try {
        const response = await fetch(`/moradores/apartamento/${idApartamento}`);
        if (!response.ok) {
          throw new Error('Morador não encontrado para este apartamento');
        }
        return await response.json();
      } catch (error) {
        showNotification('Nenhum morador encontrado para este apartamento.', 'error');
        console.error('Erro:', error);
        return null;
      }
    }
    
    // Função para atualizar informações do morador na interface
    function atualizarInfoMorador(morador) {
      if (morador) {
        infoCpf.textContent = formatarCPF(morador.cpf);
        infoNome.textContent = morador.nome;
        infoTelefone.textContent = formatarTelefone(morador.telefone);
        infoMorador.classList.remove('hidden');
      } else {
        infoCpf.textContent = '-';
        infoNome.textContent = '-';
        infoTelefone.textContent = '-';
        infoMorador.classList.add('hidden');
      }
    }
    
    // Função para atualizar informações do condomínio na interface
    function atualizarInfoCondominio(mes, ano) {
      if (mes && ano) {
        // Calcular data de vencimento (dia 10 do mês/ano)
        const dataVencimento = `${ano}-${mes.toString().padStart(2, '0')}-${DIA_VENCIMENTO.toString().padStart(2, '0')}`;
        
        infoValor.textContent = formatarMoeda(VALOR_CONDOMINIO);
        infoVencimento.textContent = formatarData(dataVencimento);
        infoCondominio.classList.remove('hidden');
      } else {
        infoValor.textContent = 'R$ 0,00';
        infoVencimento.textContent = '-';
        infoCondominio.classList.add('hidden');
      }
    }
    
    // Event listener para quando o apartamento for alterado
    inputApartamento.addEventListener('blur', async function() {
      if (this.value) {
        // Verificar se o apartamento existe
        const apartamento = await buscarApartamento(this.value);
        if (apartamento) {
          // Buscar morador do apartamento
          const morador = await buscarMorador(this.value);
          atualizarInfoMorador(morador);
        } else {
          atualizarInfoMorador(null);
        }
      } else {
        atualizarInfoMorador(null);
      }
    });
    
    // Event listener para quando a referência for alterada
    selectReferencia.addEventListener('change', function() {
      if (this.value) {
        const selectedOption = this.options[this.selectedIndex];
        const mes = selectedOption.dataset.mes;
        const ano = selectedOption.dataset.ano;
        atualizarInfoCondominio(mes, ano);
      } else {
        atualizarInfoCondominio(null, null);
      }
    });
    
    // Função para registrar o pagamento
    async function registrarPagamento(event) {
      event.preventDefault();
      
      const idApartamento = inputApartamento.value;
      const idReferencia = selectReferencia.value;
      const dataPagamento = inputDataPagamento.value;
      
      if (!idApartamento || !idReferencia || !dataPagamento) {
        showNotification('Preencha todos os campos obrigatórios.', 'error');
        return;
      }
      
      // Verificar se o apartamento existe
      const apartamento = await buscarApartamento(idApartamento);
      if (!apartamento) {
        showNotification('Apartamento não cadastrado.', 'error');
        return;
      }
      
      try {
        const response = await fetch('/pagamentos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id_apartamento: idApartamento,
            id_referencia: idReferencia,
            data_pagamento: dataPagamento,
            valor: VALOR_CONDOMINIO
          })
        });
        
        if (!response.ok) {
          throw new Error('Erro ao registrar pagamento');
        }
        
        // Limpar o formulário
        formPagamento.reset();
        infoMorador.classList.add('hidden');
        infoCondominio.classList.add('hidden');
        
        showNotification('Pagamento registrado com sucesso!', 'success');
      } catch (error) {
        showNotification('Erro ao registrar pagamento. Tente novamente.', 'error');
        console.error('Erro:', error);
      }
    }
    
    // Event Listeners
    formPagamento.addEventListener('submit', registrarPagamento);
    
    // Definir a data atual como padrão para o pagamento
    inputDataPagamento.valueAsDate = new Date();
    
    // Inicializar a página
    carregarReferencias();
  </script>
</body>
</html>
